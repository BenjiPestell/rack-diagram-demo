<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RACK ARCHITECT</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap');
:root {
  --bg: #0a0c0f; --panel: #0f1318; --panel2: #141920; --border: #1e2a35;
  --accent: #00d4ff; --accent2: #ff6b35; --accent3: #7cfc00;
  --text: #c8d8e8; --text-dim: #4a6070; --u-height: 18px; --rack-width: 230px;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background:var(--bg); color:var(--text); font-family:'Rajdhani',sans-serif; font-size:14px; height:100vh; display:flex; flex-direction:column; overflow:hidden; }
/* HEADER */
header { background:var(--panel); border-bottom:1px solid var(--border); padding:0 16px; height:46px; display:flex; align-items:center; gap:20px; flex-shrink:0; }
.logo { font-family:'Orbitron',monospace; font-weight:900; font-size:16px; color:var(--accent); letter-spacing:4px; text-shadow:0 0 20px rgba(0,212,255,0.4); white-space:nowrap; }
.logo span { color:var(--accent2); }
.header-tabs { display:flex; gap:2px; }
.tab-btn { background:none; border:none; border-bottom:2px solid transparent; color:var(--text-dim); font-family:'Rajdhani',sans-serif; font-size:12px; font-weight:600; letter-spacing:1px; padding:5px 14px; cursor:pointer; text-transform:uppercase; transition:all 0.2s; }
.tab-btn:hover { color:var(--text); }
.tab-btn.active { color:var(--accent); border-bottom-color:var(--accent); }
.header-actions { display:flex; gap:6px; margin-left:auto; }
.btn { background:transparent; border:1px solid var(--border); color:var(--text); font-family:'Rajdhani',sans-serif; font-size:12px; font-weight:600; letter-spacing:1px; padding:5px 12px; cursor:pointer; text-transform:uppercase; transition:all 0.2s; border-radius:2px; white-space:nowrap; }
.btn:hover { border-color:var(--accent); color:var(--accent); }
.btn.primary { background:var(--accent); color:var(--bg); border-color:var(--accent); }
.btn.primary:hover { background:transparent; color:var(--accent); }
/* LAYOUT */
.main { display:flex; flex:1; overflow:hidden; }
/* LEFT SIDEBAR */
.sidebar-left { width:220px; background:var(--panel); border-right:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto; }
.sidebar-section { border-bottom:1px solid var(--border); padding:10px; }
.sidebar-label { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--accent); letter-spacing:2px; text-transform:uppercase; margin-bottom:8px; }
.palette-item { display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid var(--border); border-radius:2px; margin-bottom:3px; cursor:grab; font-size:12px; font-weight:500; transition:all 0.15s; user-select:none; background:var(--panel2); }
.palette-item:hover { border-color:var(--accent); transform:translateX(2px); }
.palette-item:active { cursor:grabbing; }
.palette-color { width:10px; height:10px; border-radius:1px; flex-shrink:0; }
/* FORMS */
.form-group { margin-bottom:8px; }
.form-label { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; display:block; margin-bottom:3px; }
.form-input, .form-select { width:100%; background:var(--bg); border:1px solid var(--border); color:var(--text); font-family:'Share Tech Mono',monospace; font-size:11px; padding:5px 7px; border-radius:2px; outline:none; transition:border-color 0.2s; }
.form-input:focus, .form-select:focus { border-color:var(--accent); }
.form-select option { background:var(--panel2); }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:6px; }
/* CANVAS */
.canvas-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.canvas-toolbar { padding:6px 12px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:8px; background:var(--panel); flex-shrink:0; flex-wrap:wrap; }
.canvas-toolbar .form-input, .canvas-toolbar .form-select { width:auto; min-width:70px; padding:3px 7px; font-size:10px; }
.toolbar-label { font-family:'Share Tech Mono',monospace; font-size:9px; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; white-space:nowrap; }
.toolbar-sep { width:1px; height:22px; background:var(--border); margin:0 2px; }
.canvas-scroll { flex:1; overflow:auto; padding:20px; background: radial-gradient(ellipse at 20% 20%, rgba(0,212,255,0.02) 0%, transparent 60%), repeating-linear-gradient(0deg, transparent, transparent 17px, rgba(30,42,53,0.3) 18px), repeating-linear-gradient(90deg, transparent, transparent 17px, rgba(30,42,53,0.3) 18px); }
.racks-container { display:flex; gap:28px; align-items:flex-start; min-width:max-content; }
/* RACK */
.rack-wrapper { display:flex; flex-direction:column; align-items:center; }
.rack-header { background:var(--panel); border:1px solid var(--border); border-bottom:none; width:var(--rack-width); padding:5px 8px; display:flex; align-items:center; gap:6px; }
.rack-name-input { background:transparent; border:none; color:var(--accent); font-family:'Orbitron',monospace; font-size:10px; font-weight:700; letter-spacing:2px; width:100%; outline:none; }
.rack-controls { display:flex; gap:4px; }
.rack-ctrl-btn { background:none; border:1px solid var(--border); color:var(--text-dim); cursor:pointer; font-size:10px; padding:1px 5px; border-radius:1px; transition:all 0.2s; font-family:'Share Tech Mono',monospace; }
.rack-ctrl-btn:hover { border-color:var(--accent); color:var(--accent); }
.rack-ctrl-btn.del:hover { border-color:#ff4444; color:#ff4444; }
.rack-views { display:flex; gap:8px; }
.rack-view { display:flex; flex-direction:column; align-items:center; }
.rack-view-label { font-family:'Share Tech Mono',monospace; font-size:8px; color:var(--text-dim); letter-spacing:2px; text-align:center; margin-bottom:2px; }
.rack-body { background:var(--panel2); border:1px solid var(--border); border-top:2px solid var(--accent); width:var(--rack-width); position:relative; }
.rack-body.rear { border-top-color:var(--accent2); }
.rack-units { position:relative; }
.unit-row { height:var(--u-height); border-bottom:1px solid rgba(30,42,53,0.5); display:flex; align-items:center; position:relative; }
.unit-num { font-family:'Share Tech Mono',monospace; font-size:7px; color:var(--text-dim); width:20px; text-align:right; padding-right:3px; flex-shrink:0; user-select:none; }
.unit-slot { flex:1; height:100%; position:relative; transition:background 0.1s; }
.unit-slot.drag-over { background:rgba(0,212,255,0.12); outline:1px dashed var(--accent); }
/* DEVICE */
.device-block { position:absolute; left:20px; right:0; border:1px solid rgba(0,0,0,0.25); border-radius:1px; cursor:pointer; overflow:hidden; z-index:10; display:flex; align-items:center; padding:0 6px; user-select:none; font-size:9px; font-weight:600; font-family:'Rajdhani',sans-serif; letter-spacing:0.3px; white-space:nowrap; color:rgba(0,0,0,0.72); transition:filter 0.15s, outline 0.1s; }
.device-block:hover { filter:brightness(1.12); z-index:20; }
.device-block.selected { outline:2px solid #fff; z-index:30; }
.device-label { flex:1; overflow:hidden; text-overflow:ellipsis; }
/* RIGHT PANEL */
.sidebar-right { width:260px; background:var(--panel); border-left:1px solid var(--border); display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto; }
.prop-panel { padding:10px; flex:1; }
.prop-header { font-family:'Orbitron',monospace; font-size:10px; color:var(--accent); letter-spacing:2px; margin-bottom:12px; padding-bottom:6px; border-bottom:1px solid var(--border); }
.no-selection { color:var(--text-dim); font-family:'Share Tech Mono',monospace; font-size:10px; line-height:1.9; padding:20px 0; text-align:center; }
/* TABS PANELS */
.tab-panel { display:none; flex:1; flex-direction:column; overflow:hidden; }
.tab-panel.active { display:flex; }
/* YAML */
.yaml-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }
.yaml-output { flex:1; background:var(--bg); border:none; border-top:1px solid var(--border); color:#7ec8e3; font-family:'Share Tech Mono',monospace; font-size:11px; white-space:pre; overflow:auto; line-height:1.6; outline:none; resize:none; padding:14px 16px; }
/* WIRING */
.wiring-scroll { flex:1; overflow-y:auto; padding:10px; }
.wiring-layer { background:var(--panel2); border:1px solid var(--border); border-radius:2px; margin-bottom:8px; }
.wiring-layer-header { padding:7px 10px; display:flex; align-items:center; gap:8px; border-bottom:1px solid var(--border); }
.wiring-layer-name { font-weight:600; flex:1; font-size:13px; background:transparent; border:none; color:var(--text); font-family:'Rajdhani',sans-serif; outline:none; }
.wiring-layer-body { padding:6px; }
.connection-item { background:var(--bg); border:1px solid var(--border); border-radius:2px; padding:5px 7px; margin-bottom:3px; font-family:'Share Tech Mono',monospace; font-size:9px; display:flex; align-items:center; gap:5px; color:var(--text-dim); }
.conn-arrow { color:var(--accent); flex-shrink:0; }
.color-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
.icon-btn { background:none; border:none; color:var(--text-dim); cursor:pointer; font-size:14px; line-height:1; padding:0 2px; transition:color 0.2s; flex-shrink:0; }
.icon-btn:hover { color:#ff4444; }
.icon-btn.add:hover { color:var(--accent3); }
/* GLOBAL */
.global-scroll { flex:1; overflow-y:auto; padding:10px; }
.type-color-row { display:flex; align-items:center; gap:7px; margin-bottom:5px; }
.color-swatch { width:22px; height:22px; border-radius:2px; border:1px solid var(--border); cursor:pointer; flex-shrink:0; position:relative; }
.color-swatch input[type=color] { opacity:0; position:absolute; inset:0; width:100%; height:100%; cursor:pointer; border:none; padding:0; }
.type-name-input { flex:1; }
/* ADD RACK BTN */
.add-rack-btn { display:flex; flex-direction:column; align-items:center; justify-content:center; width:var(--rack-width); min-height:120px; border:1px dashed var(--text-dim); border-radius:2px; cursor:pointer; color:var(--text-dim); transition:all 0.2s; gap:8px; padding:20px; }
.add-rack-btn:hover { border-color:var(--accent); color:var(--accent); }
.add-rack-btn-icon { font-size:28px; }
.add-rack-btn-label { font-family:'Share Tech Mono',monospace; font-size:10px; letter-spacing:2px; text-align:center; }
/* scrollbars */
::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
::-webkit-scrollbar-thumb:hover { background:var(--text-dim); }
/* Modal */
.modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); z-index:1000; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; }
.modal { background:var(--panel); border:1px solid var(--border); border-top:2px solid var(--accent); padding:20px; min-width:340px; max-width:480px; width:90%; border-radius:2px; }
.modal-title { font-family:'Orbitron',monospace; font-size:12px; color:var(--accent); letter-spacing:2px; margin-bottom:14px; }
.modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top:14px; }
/* Tooltip */
[title] { cursor:help; }
/* checkbox */
.form-checkbox { display:flex; align-items:center; gap:6px; cursor:pointer; }
.form-checkbox input { accent-color:var(--accent); width:13px; height:13px; }
/* Range */
.cluster-range { display:flex; gap:6px; }
</style>
</head>
<body>

<header>
  <div class="logo">RACK<span>ARCH</span></div>
  <div class="header-tabs">
    <button class="tab-btn active" onclick="switchTab('design')">Design</button>
    <button class="tab-btn" onclick="switchTab('wiring')">Wiring</button>
    <button class="tab-btn" onclick="switchTab('global')">Global</button>
    <button class="tab-btn" onclick="switchTab('yaml')">YAML</button>
  </div>
  <div class="header-actions">
    <button class="btn" onclick="loadExample()">Load Example</button>
    <button class="btn primary" onclick="exportYAML()">Export YAML</button>
  </div>
</header>

<div class="main">
  <!-- LEFT SIDEBAR -->
  <div class="sidebar-left" id="leftSidebar">
    <div class="sidebar-section">
      <div class="sidebar-label">Device Types</div>
      <div id="palette"></div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Quick Add</div>
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="qa-name" placeholder="Device name" />
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="qa-type"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start U</label>
          <input class="form-input" id="qa-start" type="number" min="1" placeholder="1" />
        </div>
        <div class="form-group">
          <label class="form-label">Units</label>
          <input class="form-input" id="qa-units" type="number" min="1" placeholder="1" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">View</label>
        <select class="form-select" id="qa-view">
          <option value="front">Front</option>
          <option value="rear">Rear</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Rack</label>
        <select class="form-select" id="qa-rack"></select>
      </div>
      <button class="btn" style="width:100%" onclick="quickAddDevice()">+ Add Device</button>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-label">Cluster Device</div>
      <div class="form-group">
        <label class="form-label">Name Pattern</label>
        <input class="form-input" id="cl-name" placeholder="{N} pattern, e.g. IG {N}" />
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <select class="form-select" id="cl-type"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Start U</label>
          <input class="form-input" id="cl-start-u" type="number" min="1" placeholder="1" />
        </div>
        <div class="form-group">
          <label class="form-label">Units Each</label>
          <input class="form-input" id="cl-units" type="number" min="1" placeholder="4" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">N Start</label>
          <input class="form-input" id="cl-n-start" type="number" min="1" placeholder="1" />
        </div>
        <div class="form-group">
          <label class="form-label">N End</label>
          <input class="form-input" id="cl-n-end" type="number" min="1" placeholder="3" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">View</label>
          <select class="form-select" id="cl-view">
            <option value="front">Front</option>
            <option value="rear">Rear</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Spacing</label>
          <input class="form-input" id="cl-spacing" type="number" min="0" placeholder="0" />
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Rack</label>
        <select class="form-select" id="cl-rack"></select>
      </div>
      <button class="btn" style="width:100%" onclick="quickAddCluster()">+ Add Cluster</button>
    </div>
  </div>

  <!-- CANVAS (design tab) -->
  <div class="canvas-area">
    <div class="tab-panel active" id="tab-design" style="overflow:hidden;flex:1;display:flex;flex-direction:column;">
      <div class="canvas-toolbar">
        <span class="toolbar-label">Rack:</span>
        <select class="form-select" id="tb-rack-select" onchange="highlightRack(this.value)" style="min-width:110px"></select>
        <div class="toolbar-sep"></div>
        <span class="toolbar-label">Total U:</span>
        <input class="form-input" id="tb-total-u" type="number" min="1" max="100" style="width:52px" onchange="setRackTotalU()" />
        <div class="toolbar-sep"></div>
        <button class="btn" onclick="addRack()">+ Rack</button>
        <button class="btn" onclick="cloneSelectedRack()">Clone</button>
      </div>
      <div class="canvas-scroll" id="canvasScroll">
        <div class="racks-container" id="racksContainer"></div>
      </div>
    </div>

    <div class="tab-panel" id="tab-wiring" style="overflow:hidden;flex:1;display:flex;flex-direction:column;">
      <div class="canvas-toolbar">
        <button class="btn" onclick="addWiringLayer()">+ Layer</button>
        <span class="toolbar-label" style="margin-left:8px;color:var(--text-dim)">Define network/power layers and connections</span>
      </div>
      <div class="wiring-scroll" id="wiringScroll"></div>
    </div>

    <div class="tab-panel" id="tab-global" style="overflow:hidden;flex:1;display:flex;flex-direction:column;">
      <div class="global-scroll">
        <div class="sidebar-label" style="margin-bottom:8px">Physical Parameters</div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Inter-rack Dist (m)</label>
            <input class="form-input" id="g-inter-rack" type="number" step="0.1" value="5.0" />
          </div>
          <div class="form-group">
            <label class="form-label">Cable Slack (m)</label>
            <input class="form-input" id="g-cable-slack" type="number" step="0.05" value="0.2" />
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Front-to-Back Length (m)</label>
          <input class="form-input" id="g-front-back" type="number" step="0.05" value="0.5" />
        </div>
        <div class="sidebar-label" style="margin-top:14px;margin-bottom:8px">Device Type Colors</div>
        <div id="type-colors-list"></div>
        <button class="btn" style="width:100%;margin-top:6px" onclick="addTypeColor()">+ Add Type</button>
      </div>
    </div>

    <div class="tab-panel" id="tab-yaml" style="overflow:hidden;flex:1;display:flex;flex-direction:column;">
      <div class="canvas-toolbar">
        <button class="btn primary" onclick="generateYAML()">Generate YAML</button>
        <button class="btn" onclick="copyYAML()">Copy</button>
        <button class="btn" onclick="downloadYAML()">Download</button>
      </div>
      <div class="yaml-area">
        <textarea class="yaml-output" id="yamlOutput" readonly spellcheck="false">// Click "Generate YAML" or switch to YAML tab</textarea>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL - Properties -->
  <div class="sidebar-right">
    <div class="prop-panel">
      <div class="prop-header" id="propHeader">PROPERTIES</div>
      <div id="propContent"><div class="no-selection">Select a device<br>to edit properties</div></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-title" id="modalTitle">ADD CONNECTION</div>
    <div id="modalBody"></div>
    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn primary" id="modalConfirm" onclick="">Confirm</button>
    </div>
  </div>
</div>

<script>
// ==================== STATE ====================
const state = {
  racks: [],
  typeColors: {
    pc: "#E8F4F8",
    pdu: "#AAAAAA",
    Shelf: "#ced3db",
    realtime: "#FFE8D8",
    "cable management": "#C4C4C4",
    switch: "#B8D6D6",
    customer: "#ffd9d6"
  },
  wiringLayers: [],
  globals: { interRackDist: 5.0, cableSlack: 0.2, frontBackLength: 0.5 },
  selectedDevice: null,
  nextRackId: 1,
  nextLayerId: 1
};

let draggedType = null;
let dragOverRack = null;
let dragOverU = null;
let dragOverView = null;

// ==================== INIT ====================
function init() {
  renderPalette();
  renderTypeColors();
  renderRacks();
  updateRackSelects();
  populateTypeSelects();
}

function populateTypeSelects() {
  ['qa-type','cl-type'].forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    el.innerHTML = '';
    Object.keys(state.typeColors).forEach(t => {
      el.innerHTML += `<option value="${t}">${t}</option>`;
    });
  });
}

function updateRackSelects() {
  const ids = ['qa-rack','cl-rack','tb-rack-select'];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if(!el) return;
    const cur = el.value;
    el.innerHTML = state.racks.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
    if(cur) el.value = cur;
  });
  const tbU = document.getElementById('tb-total-u');
  if(tbU && state.racks.length > 0) {
    const sel = document.getElementById('tb-rack-select').value;
    const r = state.racks.find(r => r.id === sel);
    if(r) tbU.value = r.totalU;
  }
}

// ==================== PALETTE ====================
function renderPalette() {
  const p = document.getElementById('palette');
  p.innerHTML = Object.entries(state.typeColors).map(([t,c]) =>
    `<div class="palette-item" draggable="true" ondragstart="paletteDragStart(event,'${t}')" title="Drag to rack">
      <div class="palette-color" style="background:${c}"></div><span>${t}</span>
    </div>`
  ).join('');
  populateTypeSelects();
}

function paletteDragStart(e, type) {
  draggedType = type;
  e.dataTransfer.effectAllowed = 'copy';
}

// ==================== TYPE COLORS ====================
function renderTypeColors() {
  const list = document.getElementById('type-colors-list');
  if(!list) return;
  list.innerHTML = Object.entries(state.typeColors).map(([name, color]) => `
    <div class="type-color-row">
      <div class="color-swatch" style="background:${color}">
        <input type="color" value="${color}" onchange="updateTypeColor('${name}',this.value)" />
      </div>
      <input class="form-input type-name-input" value="${name}" style="flex:1" onblur="renameType('${name}',this.value)" />
      <button class="icon-btn" onclick="removeType('${name}')" title="Remove">×</button>
    </div>
  `).join('');
  renderPalette();
}

function updateTypeColor(name, color) {
  state.typeColors[name] = color;
  renderTypeColors();
  renderRacks();
}

function renameType(oldName, newName) {
  if(oldName === newName || !newName.trim()) return;
  const colors = {};
  Object.entries(state.typeColors).forEach(([k,v]) => { colors[k===oldName?newName:k] = v; });
  state.typeColors = colors;
  state.racks.forEach(r => {
    ['front','rear'].forEach(view => r[view].forEach(d => { if(d.type===oldName) d.type=newName; }));
  });
  renderTypeColors();
  renderRacks();
}

function removeType(name) {
  delete state.typeColors[name];
  renderTypeColors();
  renderRacks();
}

function addTypeColor() {
  const name = 'new_type_' + Date.now();
  state.typeColors[name] = '#888888';
  renderTypeColors();
}

// ==================== RACKS ====================
function addRack() {
  const id = 'rack' + (state.nextRackId++);
  state.racks.push({ id, name: `Rack ${state.racks.length+1}`, totalU: 42, front: [], rear: [] });
  renderRacks();
  updateRackSelects();
  document.getElementById('tb-rack-select').value = id;
}

function deleteRack(id) {
  if(!confirm('Delete this rack?')) return;
  state.racks = state.racks.filter(r => r.id !== id);
  renderRacks();
  updateRackSelects();
}

function cloneSelectedRack() {
  const selId = document.getElementById('tb-rack-select').value;
  const r = state.racks.find(r => r.id === selId);
  if(!r) { addRack(); return; }
  const newId = 'rack' + (state.nextRackId++);
  const cloned = JSON.parse(JSON.stringify(r));
  cloned.id = newId;
  cloned.name = r.name + ' (copy)';
  state.racks.push(cloned);
  renderRacks();
  updateRackSelects();
}

function setRackTotalU() {
  const selId = document.getElementById('tb-rack-select').value;
  const r = state.racks.find(r => r.id === selId);
  const val = parseInt(document.getElementById('tb-total-u').value);
  if(r && val > 0) { r.totalU = val; renderRacks(); }
}

function highlightRack(id) {
  const r = state.racks.find(r => r.id === id);
  const tbU = document.getElementById('tb-total-u');
  if(r && tbU) tbU.value = r.totalU;
}

// ==================== RENDER RACKS ====================
function renderRacks() {
  const container = document.getElementById('racksContainer');
  container.innerHTML = '';
  state.racks.forEach(rack => container.appendChild(buildRackEl(rack)));
  // add rack button
  const addBtn = document.createElement('div');
  addBtn.className = 'rack-wrapper';
  addBtn.innerHTML = `<div class="add-rack-btn" onclick="addRack()">
    <div class="add-rack-btn-icon">+</div>
    <div class="add-rack-btn-label">ADD RACK</div>
  </div>`;
  container.appendChild(addBtn);
}

function buildRackEl(rack) {
  const wrapper = document.createElement('div');
  wrapper.className = 'rack-wrapper';
  wrapper.id = 'rack-wrapper-' + rack.id;

  // header
  wrapper.innerHTML = `
    <div class="rack-header" style="width:calc(var(--rack-width)*2 + 8px)">
      <input class="rack-name-input" value="${rack.name}" onchange="rack_rename('${rack.id}',this.value)" style="max-width:140px" />
      <div class="rack-controls">
        <input class="form-input" type="number" value="${rack.totalU}" min="1" max="100" style="width:44px;padding:1px 4px;font-size:9px" title="Total U" onchange="rack_setU('${rack.id}',this.value)" />
        <span style="font-family:'Share Tech Mono',monospace;font-size:9px;color:var(--text-dim)">U</span>
        <button class="rack-ctrl-btn del" onclick="deleteRack('${rack.id}')">DEL</button>
      </div>
    </div>
    <div class="rack-views"></div>`;

  const viewsEl = wrapper.querySelector('.rack-views');

  ['front','rear'].forEach(view => {
    const viewDiv = document.createElement('div');
    viewDiv.className = 'rack-view';
    viewDiv.innerHTML = `<div class="rack-view-label">${view.toUpperCase()}</div>`;

    const body = document.createElement('div');
    body.className = 'rack-body' + (view==='rear'?' rear':'');
    body.style.width = 'var(--rack-width)';

    const unitsDiv = document.createElement('div');
    unitsDiv.className = 'rack-units';
    unitsDiv.style.height = `${rack.totalU * 18}px`;

    // Build unit rows
    for(let u = rack.totalU; u >= 1; u--) {
      const row = document.createElement('div');
      row.className = 'unit-row';
      row.innerHTML = `<div class="unit-num">${u}</div><div class="unit-slot" 
        ondragover="unitDragOver(event,'${rack.id}','${view}',${u})" 
        ondragleave="unitDragLeave(event)" 
        ondrop="unitDrop(event,'${rack.id}','${view}',${u})"></div>`;
      unitsDiv.appendChild(row);
    }

    // Place devices
    rack[view].forEach(device => {
      if(!device.start_u || !device.units) return;
      const color = state.typeColors[device.type] || '#888';
      const topPx = (rack.totalU - device.start_u - device.units + 1) * 18;
      const heightPx = device.units * 18 - 1;
      const devEl = document.createElement('div');
      devEl.className = 'device-block' + (state.selectedDevice && state.selectedDevice.rackId === rack.id && state.selectedDevice.view === view && state.selectedDevice.name === device.name ? ' selected' : '');
      devEl.style.cssText = `background:${color};top:${topPx}px;height:${heightPx}px;`;
      const displayName = device._isCluster
        ? `${device.name.replace('{N}','')} ${device._clusterStart}-${device._clusterEnd}`
        : device.name;
      devEl.innerHTML = `<span class="device-label" title="${device.name}">${displayName}</span>`;
      devEl.onclick = (e) => { e.stopPropagation(); selectDevice(rack.id, view, device); };
      unitsDiv.appendChild(devEl);
    });

    body.appendChild(unitsDiv);
    viewDiv.appendChild(body);
    viewsEl.appendChild(viewDiv);
  });

  return wrapper;
}

function rack_rename(id, name) {
  const r = state.racks.find(r => r.id === id);
  if(r) { r.name = name; updateRackSelects(); }
}
function rack_setU(id, val) {
  const r = state.racks.find(r => r.id === id);
  if(r) { r.totalU = parseInt(val)||42; renderRacks(); }
}

// ==================== DRAG & DROP ====================
function unitDragOver(e, rackId, view, u) {
  if(!draggedType) return;
  e.preventDefault();
  e.dataTransfer.dropEffect = 'copy';
  e.currentTarget.classList.add('drag-over');
  dragOverRack = rackId; dragOverView = view; dragOverU = u;
}
function unitDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}
function unitDrop(e, rackId, view, u) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if(!draggedType) return;
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) return;
  const name = draggedType + ' ' + (rack[view].filter(d=>d.type===draggedType).length+1);
  rack[view].push({ name, start_u: u, units: 1, type: draggedType });
  draggedType = null;
  renderRacks();
  selectDevice(rackId, view, rack[view][rack[view].length-1]);
}

// ==================== DEVICE SELECTION ====================
function selectDevice(rackId, view, device) {
  state.selectedDevice = { rackId, view, name: device.name };
  renderRacks();
  renderDeviceProps(rackId, view, device);
}

function renderDeviceProps(rackId, view, device) {
  document.getElementById('propHeader').textContent = 'DEVICE PROPERTIES';
  const types = Object.keys(state.typeColors).map(t => `<option value="${t}" ${device.type===t?'selected':''}>${t}</option>`).join('');
  let clusterHtml = '';
  if(device._isCluster) {
    clusterHtml = `
      <div class="form-row">
        <div class="form-group"><label class="form-label">N Start</label><input class="form-input" id="p-n-start" type="number" value="${device._clusterStart||1}" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','_clusterStart',parseInt(this.value)||1)" /></div>
        <div class="form-group"><label class="form-label">N End</label><input class="form-input" id="p-n-end" type="number" value="${device._clusterEnd||1}" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','_clusterEnd',parseInt(this.value)||1)" /></div>
      </div>
      <div class="form-group"><label class="form-label">Spacing (U)</label><input class="form-input" type="number" value="${device._spacing||0}" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','_spacing',parseInt(this.value)||0)" /></div>`;
  }
  document.getElementById('propContent').innerHTML = `
    <div class="form-group"><label class="form-label">Name</label>
      <input class="form-input" value="${device.name}" onblur="renameDevice('${rackId}','${view}','${device.name}',this.value)" /></div>
    <div class="form-group"><label class="form-label">Type</label>
      <select class="form-select" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','type',this.value)">${types}</select></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Start U</label>
        <input class="form-input" type="number" min="1" value="${device.start_u||''}" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','start_u',parseInt(this.value)||1)" /></div>
      <div class="form-group"><label class="form-label">Units</label>
        <input class="form-input" type="number" min="1" value="${device.units||1}" onchange="updateDeviceProp('${rackId}','${view}','${device.name}','units',parseInt(this.value)||1)" /></div>
    </div>
    ${clusterHtml}
    <div class="form-group" style="margin-top:8px">
      <label class="form-checkbox"><input type="checkbox" ${device._isCluster?'checked':''} onchange="toggleCluster('${rackId}','${view}','${device.name}',this.checked)" /> <span>Cluster (uses {N})</span></label>
    </div>
    <button class="btn danger" style="width:100%;margin-top:10px" onclick="deleteDevice('${rackId}','${view}','${device.name}')">Delete Device</button>
  `;
}

function updateDeviceProp(rackId, view, name, prop, value) {
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) return;
  const dev = rack[view].find(d => d.name === name);
  if(!dev) return;
  dev[prop] = value;
  renderRacks();
}

function renameDevice(rackId, view, oldName, newName) {
  if(!newName.trim() || oldName === newName) return;
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) return;
  const dev = rack[view].find(d => d.name === oldName);
  if(dev) {
    dev.name = newName;
    state.selectedDevice.name = newName;
    renderRacks();
    renderDeviceProps(rackId, view, dev);
  }
}

function toggleCluster(rackId, view, name, isCluster) {
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) return;
  const dev = rack[view].find(d => d.name === name);
  if(!dev) return;
  dev._isCluster = isCluster;
  if(isCluster) {
    dev._clusterStart = dev._clusterStart || 1;
    dev._clusterEnd = dev._clusterEnd || 3;
    dev._spacing = dev._spacing || 0;
    if(!dev.name.includes('{N}')) dev.name = dev.name + ' {N}';
    state.selectedDevice.name = dev.name;
  }
  renderRacks();
  renderDeviceProps(rackId, view, dev);
}

function deleteDevice(rackId, view, name) {
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) return;
  rack[view] = rack[view].filter(d => d.name !== name);
  state.selectedDevice = null;
  document.getElementById('propContent').innerHTML = '<div class="no-selection">Select a device<br>to edit properties</div>';
  document.getElementById('propHeader').textContent = 'PROPERTIES';
  renderRacks();
}

// ==================== QUICK ADD ====================
function quickAddDevice() {
  const name = document.getElementById('qa-name').value.trim();
  const type = document.getElementById('qa-type').value;
  const start_u = parseInt(document.getElementById('qa-start').value) || 1;
  const units = parseInt(document.getElementById('qa-units').value) || 1;
  const view = document.getElementById('qa-view').value;
  const rackId = document.getElementById('qa-rack').value;
  if(!name) { alert('Enter a device name'); return; }
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) { alert('Add a rack first'); return; }
  rack[view].push({ name, start_u, units, type });
  renderRacks();
}

function quickAddCluster() {
  const name = document.getElementById('cl-name').value.trim();
  const type = document.getElementById('cl-type').value;
  const start_u = parseInt(document.getElementById('cl-start-u').value) || 1;
  const units = parseInt(document.getElementById('cl-units').value) || 1;
  const nStart = parseInt(document.getElementById('cl-n-start').value) || 1;
  const nEnd = parseInt(document.getElementById('cl-n-end').value) || 3;
  const view = document.getElementById('cl-view').value;
  const spacing = parseInt(document.getElementById('cl-spacing').value) || 0;
  const rackId = document.getElementById('cl-rack').value;
  if(!name) { alert('Enter a name pattern'); return; }
  const rack = state.racks.find(r => r.id === rackId);
  if(!rack) { alert('Add a rack first'); return; }
  const clusterName = name.includes('{N}') ? name : name + ' {N}';
  rack[view].push({ name: clusterName, start_u, units, type, _isCluster: true, _clusterStart: nStart, _clusterEnd: nEnd, _spacing: spacing });
  renderRacks();
}

// ==================== WIRING LAYERS ====================
function renderWiringLayers() {
  const scroll = document.getElementById('wiringScroll');
  scroll.innerHTML = '';
  state.wiringLayers.forEach((layer, li) => {
    const div = document.createElement('div');
    div.className = 'wiring-layer';
    div.innerHTML = `
      <div class="wiring-layer-header">
        <div class="color-dot" style="background:${layer.edgeColor||'#888'}"></div>
        <input class="wiring-layer-name" value="${layer.name}" onblur="state.wiringLayers[${li}].name=this.value" />
        <div style="display:flex;gap:4px;align-items:center">
          <input type="color" value="${layer.edgeColor||'#888888'}" style="width:22px;height:22px;border:none;background:none;cursor:pointer;padding:0" onchange="state.wiringLayers[${li}].edgeColor=this.value;renderWiringLayers()" />
          <select class="form-select" style="width:90px;padding:2px 4px;font-size:10px" onchange="state.wiringLayers[${li}].cableType=this.value">
            ${['Ethernet','C13-C14','Included','Fibre','Other'].map(t=>`<option ${layer.cableType===t?'selected':''}>${t}</option>`).join('')}
          </select>
          <button class="icon-btn" onclick="deleteWiringLayer(${li})">×</button>
        </div>
      </div>
      <div class="wiring-layer-body">
        ${(layer.connections||[]).map((c,ci) => `
          <div class="connection-item">
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;">${c.from} <span class="conn-arrow">→</span> ${Array.isArray(c.to)?c.to.join(', '):c.to}${c.start!==undefined?` [${c.start}-${c.end}]`:''}</span>
            <button class="icon-btn" onclick="deleteConnection(${li},${ci})">×</button>
          </div>
        `).join('')}
        <button class="btn" style="width:100%;margin-top:4px;font-size:11px" onclick="openAddConnection(${li})">+ Connection</button>
      </div>`;
    scroll.appendChild(div);
  });
}

function addWiringLayer() {
  state.wiringLayers.push({ name: 'New Layer', edgeColor: '#888888', cableType: 'Ethernet', connections: [] });
  renderWiringLayers();
}

function deleteWiringLayer(i) {
  state.wiringLayers.splice(i, 1);
  renderWiringLayers();
}

function deleteConnection(li, ci) {
  state.wiringLayers[li].connections.splice(ci, 1);
  renderWiringLayers();
}

function openAddConnection(li) {
  const modal = document.getElementById('modalOverlay');
  document.getElementById('modalTitle').textContent = 'ADD CONNECTION';
  const allDevices = getAllDeviceNames();
  const opts = allDevices.map(d => `<option value="${d}">${d}</option>`).join('');
  document.getElementById('modalBody').innerHTML = `
    <div class="form-group"><label class="form-label">From</label>
      <input class="form-input" id="conn-from" list="dev-list-from" placeholder="Device name" />
      <datalist id="dev-list-from">${opts}</datalist></div>
    <div class="form-group"><label class="form-label">To (comma separated or single)</label>
      <input class="form-input" id="conn-to" list="dev-list-to" placeholder="Device name or 'Dev {N}'" />
      <datalist id="dev-list-to">${opts}</datalist></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">N Start (cluster)</label><input class="form-input" id="conn-start" type="number" placeholder="1" /></div>
      <div class="form-group"><label class="form-label">N End (cluster)</label><input class="form-input" id="conn-end" type="number" placeholder="" /></div>
    </div>`;
  document.getElementById('modalConfirm').onclick = () => {
    const from = document.getElementById('conn-from').value.trim();
    const toRaw = document.getElementById('conn-to').value.trim();
    const start = document.getElementById('conn-start').value;
    const end = document.getElementById('conn-end').value;
    if(!from || !toRaw) { alert('Fill in from and to'); return; }
    const toArr = toRaw.split(',').map(s=>s.trim()).filter(Boolean);
    const conn = { from, to: toArr.length===1?toArr[0]:toArr };
    if(start) { conn.start = parseInt(start); conn.end = parseInt(end)||parseInt(start); }
    state.wiringLayers[li].connections.push(conn);
    closeModal();
    renderWiringLayers();
  };
  modal.classList.add('open');
}

function getAllDeviceNames() {
  const names = new Set();
  state.racks.forEach(r => {
    ['front','rear'].forEach(v => r[v].forEach(d => names.add(d.name)));
  });
  return [...names];
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('open'); }

// ==================== YAML GENERATION ====================
function generateYAML() {
  const g = state.globals;
  let yaml = '';
  yaml += `inter_rack_distance: ${parseFloat(document.getElementById('g-inter-rack').value||g.interRackDist).toFixed(1)}  # m\n`;
  yaml += `cable_slack_length: ${parseFloat(document.getElementById('g-cable-slack').value||g.cableSlack).toFixed(2)}  # m\n`;
  yaml += `front_to_back_length: ${parseFloat(document.getElementById('g-front-back').value||g.frontBackLength).toFixed(2)}  # m\n\n`;
  
  yaml += 'type_colors:\n';
  Object.entries(state.typeColors).forEach(([t,c]) => {
    yaml += `  ${t}: "${c}"\n`;
  });

  yaml += '\nracks:\n';
  state.racks.forEach((rack, ri) => {
    yaml += `  # ${rack.name}\n  - rack:\n      id: ${rack.id}\n      name: ${rack.name}\n      total_u: ${rack.totalU}\n    \n`;
    ['front','rear'].forEach(view => {
      yaml += `    ${view}:\n`;
      if(rack[view].length === 0) yaml += `      []\n`;
      rack[view].forEach(dev => {
        yaml += `      - name: ${dev.name.includes(' ')||dev.name.includes('{')? '"'+dev.name+'"' : dev.name}\n`;
        if(dev.start_u) yaml += `        start_u: ${dev.start_u}\n`;
        if(dev._isCluster) {
          yaml += `        start: ${dev._clusterStart||1}\n`;
          yaml += `        end: ${dev._clusterEnd||1}\n`;
        }
        if(dev.units) yaml += `        units: ${dev.units}\n`;
        if(dev._isCluster) yaml += `        spacing: ${dev._spacing||0}\n`;
        yaml += `        type: ${dev.type}\n`;
      });
      yaml += '\n';
    });
  });

  if(state.wiringLayers.length > 0) {
    yaml += 'wiring_layers:\n\n';
    state.wiringLayers.forEach(layer => {
      yaml += `  - name: ${layer.name}\n`;
      if(layer.edgeColor) yaml += `    edge_color: "${layer.edgeColor}"\n`;
      yaml += `    cable_type: "${layer.cableType||'Ethernet'}"\n`;
      yaml += `    connections:\n`;
      (layer.connections||[]).forEach(c => {
        yaml += `      - from: ${c.from.includes(' ')?'"'+c.from+'"':c.from}\n`;
        if(Array.isArray(c.to)) {
          yaml += `        to:\n`;
          c.to.forEach(t => yaml += `          - ${t.includes(' ')||t.includes('{') ? '"'+t+'"' : t}\n`);
        } else {
          yaml += `        to: ${c.to.includes(' ')||c.to.includes('{') ? '"'+c.to+'"' : c.to}\n`;
        }
        if(c.start !== undefined) { yaml += `        start: ${c.start}\n`; yaml += `        end: ${c.end}\n`; }
      });
      yaml += '\n';
    });
  }

  document.getElementById('yamlOutput').value = yaml;
  return yaml;
}

function exportYAML() {
  generateYAML();
  switchTab('yaml');
}

function copyYAML() {
  const yaml = generateYAML();
  navigator.clipboard.writeText(yaml).then(() => alert('YAML copied!'));
}

function downloadYAML() {
  const yaml = generateYAML();
  const a = document.createElement('a');
  a.href = 'data:text/yaml;charset=utf-8,' + encodeURIComponent(yaml);
  a.download = 'rack-layout.yaml';
  a.click();
}

// ==================== TABS ====================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => {
    const tabs = ['design','wiring','global','yaml'];
    b.classList.toggle('active', tabs[i] === tab);
  });
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  if(tab === 'wiring') renderWiringLayers();
  if(tab === 'yaml') generateYAML();
}

// ==================== LOAD EXAMPLE ====================
function loadExample() {
  if(!confirm('Load example data? This will replace current work.')) return;
  state.typeColors = { pc:"#E8F4F8", pdu:"#AAAAAA", Shelf:"#ced3db", realtime:"#FFE8D8", "cable management":"#C4C4C4", switch:"#B8D6D6", customer:"#ffd9d6" };
  state.nextRackId = 5;
  state.racks = [
    { id:'rack1', name:'Rack 1', totalU:42,
      front:[
        {name:'UPS',start_u:42,units:3,type:'pdu'},
        {name:'KVM Shelf {N}',start_u:39,units:1,type:'Shelf',_isCluster:true,_clusterStart:1,_clusterEnd:3,_spacing:0},
        {name:'Operator PC',start_u:27,units:4,type:'pc'},
        {name:'Physics PC',start_u:23,units:4,type:'pc'},
        {name:'Spectator IG',start_u:19,units:4,type:'pc'},
        {name:'Telemetry',start_u:12,units:3,type:'pc'},
        {name:'dSPACE Controller',start_u:9,units:3,type:'realtime'},
        {name:'dSPACE',start_u:6,units:6,type:'realtime'},
      ],
      rear:[
        {name:'R1 16A PDU A',start_u:42,units:1,type:'pdu'},
        {name:'Company Network Switch',start_u:41,units:1,type:'switch'},
        {name:'CCTV Switch',start_u:40,units:1,type:'switch'},
        {name:'KVM Switch',start_u:39,units:1,type:'switch'},
        {name:'Audio Switch',start_u:38,units:1,type:'switch'},
        {name:'R1 EU PDU',start_u:37,units:1,type:'pdu'},
        {name:'RME Digiface',start_u:36,units:2,type:'Shelf'},
        {name:'Media Converters',start_u:34,units:4,type:'Shelf'},
        {name:'Cable Manager',start_u:24,units:1,type:'cable management'},
        {name:'R1 16A PDU B',start_u:22,units:1,type:'pdu'},
        {name:'Cable Manager',start_u:6,units:1,type:'cable management'},
        {name:'Graphics Switch 1',start_u:3,units:1,type:'switch'},
        {name:'R1 16A PDU C',start_u:1,units:1,type:'pdu'},
        {name:'Vertical PDU 1',type:'pdu'},
        {name:'Mains in 1',type:'pdu'},
        {name:'Company Net in',type:'switch'},
      ]
    },
    { id:'rack2', name:'Rack 2', totalU:42,
      front:[
        {name:'Customer 2',start_u:42,units:15,type:'customer'},
        {name:'"RVD {N}"',start_u:20,units:4,type:'pc',_isCluster:true,_clusterStart:1,_clusterEnd:3,_spacing:0},
        {name:'"IG {N}"',start_u:8,units:4,type:'pc',_isCluster:true,_clusterStart:1,_clusterEnd:2,_spacing:0},
      ],
      rear:[
        {name:'R2 16A PDU A',start_u:42,units:1,type:'pdu'},
        {name:'Cable manager',start_u:24,units:1,type:'cable management'},
        {name:'R2 16A PDU B',start_u:21,units:1,type:'pdu'},
        {name:'Cable manager',start_u:6,units:1,type:'cable management'},
        {name:'Graphics Switch 2',start_u:3,units:1,type:'switch'},
        {name:'R2 16A PDU C',start_u:1,units:1,type:'pdu'},
        {name:'Vertical PDU 2',type:'pdu'},
        {name:'Mains in 2',type:'pdu'},
      ]
    }
    ];
    state.wiringLayers = [
        { name:'Ethernet', edgeColor:'#1f77b4', cableType:'Ethernet', connections:[
        { from:'Operator PC', to:'Company Network Switch' },
        { from:'Physics PC', to:'Company Network Switch' },
        { from:'Spectator IG', to:'Company Network Switch' },
        { from:'Telemetry', to:'Company Network Switch' },
        { from:'dSPACE Controller', to:'Company Network Switch' },
        { from:'dSPACE', to:'Company Network Switch' },
        { from:'Customer 2', to:['Graphics Switch 1','Graphics Switch 2'] }
        ]},
        { name:'Video', edgeColor:'#ff7f0e', cableType:'Included', connections:[
        { from:'Operator PC', to:'KVM Switch' },
        { from:'Physics PC', to:'KVM Switch' },
        { from:'Spectator IG', to:'KVM Switch' },
        { from:'Telemetry', to:'KVM Switch' },
        { from:'dSPACE Controller', to:'KVM Switch' },
        { from:'dSPACE', to:'KVM Switch' },
        { from:'RVD 1', to:'Graphics Switch 1' },
        { from:'RVD 2', to:'Graphics Switch 1' },
        { from:'RVD 3', to:'Graphics Switch 1' },
        ]},
        { name:'Power', edgeColor:'#2ca02c', cableType:'C13-C14', connections:[
        { from:['UPS','R1 EU PDU'], to:['Operator PC','Physics PC','Spectator IG','Telemetry','dSPACE Controller','dSPACE'] },
        { from:['R1 16A PDU A','R1 16A PDU B','R1 16A PDU C'], to:['UPS'] },
        { from:['R2 16A PDU A','R2 16A PDU B','R2 16A PDU C'], to:['UPS'] },
        ]}

    ];
    renderTypeColors();
    renderRacks();
    updateRackSelects();
}